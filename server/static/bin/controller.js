// Generated by CoffeeScript 1.9.3
(function() {
  define(["jquery", "plugins", "focusManager", "chatCommands", "scrollManager", "userName", "uiSetup"], function($, plugins, focusManager, chatCommands, scrollManager) {
    var messagesDiv, render, sendMessage;
    window.send = {};
    window.stuck = true;
    window.baseTitle = "Bonfire";
    messagesDiv = $('#messages');
    scrollManager.setup(messagesDiv);
    sendMessage = function() {
      var text;
      text = $('input').val();
      text = text.trim();
      chatCommands(text);
      if (text.length < 500 && text.length !== 0) {
        scrollManager.stuck = true;
        send({
          text: $('#input').val(),
          displayName: $('#name-input').val()
        });
      }
      localStorage.displayName = $('#name-input').val();
      return $('#input').val('');
    };
    $('#input').keydown(function(e) {
      if (e.which === 13) {
        e.preventDefault();
        return sendMessage();
      }
    });
    $('#send').click(function(e) {
      return sendMessage();
    });
    $('#input').focus();
    render = function(message, id) {
      var copy, elementAtNextIndex, j, len, plugin;
      if (message != null) {
        copy = JSON.parse(JSON.stringify(message));
        for (j = 0, len = plugins.length; j < len; j++) {
          plugin = plugins[j];
          plugin(copy, id);
        }
        elementAtNextIndex = $('div[data-index="#{id}"]');
        if (elementAtNextIndex.length !== 0) {
          return elementAtNextIndex.before(copy.render);
        } else {
          return messagesDiv.append(copy.render);
        }
      }
    };
    return {
      startup: function(sendCallback) {
        window.send = sendCallback;
        return window.stuck = true;
      },
      recieved: function(message, id) {
        render(message, id);
        if ((window.notifier != null) && !focusManager.focused) {
          return window.notifier.notify(true);
        }
      },
      event: function(message) {},
      connected: function(messages) {
        var i, j, k, ref, ref1, ref2, results, results1;
        if (messages.length > 50) {
          results = [];
          for (i = j = ref = messages.length - 50, ref1 = messages.length - 1; ref <= ref1 ? j <= ref1 : j >= ref1; i = ref <= ref1 ? ++j : --j) {
            results.push(render(messages[i], i));
          }
          return results;
        } else if (messages.length > 0) {
          results1 = [];
          for (i = k = 0, ref2 = messages.length - 1; 0 <= ref2 ? k <= ref2 : k >= ref2; i = 0 <= ref2 ? ++k : --k) {
            results1.push(render(messages[i], i));
          }
          return results1;
        }
      },
      disconnected: function() {}
    };
  });

}).call(this);
